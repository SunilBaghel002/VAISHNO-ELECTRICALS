<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Panel - VAISHNO ELECTRICALS</title>
    <link rel="shortcut icon" href="/images/download.svg" type="image/x-icon" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <style>
      /* Reset and Base Styles */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: "Poppins", sans-serif;
        line-height: 1.6;
        color: #333;
        overflow-x: hidden;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }
      html {
        scroll-behavior: smooth;
      }
      a {
        text-decoration: none;
      }

      /* Header Styles */
      header {
        background: linear-gradient(
          135deg,
          #0f172a 0%,
          #1e293b 50%,
          #334155 100%
        );
        backdrop-filter: blur(10px);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        position: fixed;
        width: 100%;
        top: 0;
        z-index: 1000;
        transition: background 0.3s ease;
      }
      .header-scrolled {
        background: rgba(255, 255, 255, 0.98);
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
      }
      .header-scrolled .nav-links a {
        color: #333;
      }
      .header-scrolled .logo img {
        filter: invert(0%);
      }
      nav {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 5%;
        max-width: 1400px;
        margin: 0 auto;
      }
      .logo {
        font-size: 2rem;
        font-weight: 800;
        background: linear-gradient(135deg, #1e40af, #3b82f6, #06b6d4);
        background-clip: text;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      .logo i {
        color: #1e40af;
        -webkit-text-fill-color: #1e40af;
      }
      .logo img {
        width: 80px;
        height: 40px;
        filter: invert(100%);
      }
      .nav-links {
        display: flex;
        list-style: none;
        gap: 2rem;
      }
      .nav-links a {
        color: #cbd5e1;
        font-weight: 500;
        transition: color 0.3s ease;
      }
      .nav-links a:hover {
        color: #3b82f6;
      }
      .mobile-menu-btn {
        display: none;
        background: none;
        border: none;
        font-size: 1.5rem;
        color: #1e40af;
        cursor: pointer;
      }

      /* Admin Section */
      .admin-section {
        padding: 100px 5% 80px;
        background: #f8fafc;
        flex: 1;
      }
      .admin-container {
        max-width: 1200px;
        margin: 0 auto;
      }
      .section-title {
        font-size: 2.5rem;
        text-align: center;
        margin-bottom: 1rem;
        font-weight: 700;
        background: linear-gradient(135deg, #1e40af, #3b82f6);
        background-clip: text;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }
      .product-form,
      .product-list {
        background: white;
        padding: 2rem;
        border-radius: 15px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
      }
      .product-form h3,
      .product-list h3 {
        font-size: 1.5rem;
        color: #1e40af;
        margin-bottom: 1.5rem;
      }
      .form-group {
        position: relative;
        margin-bottom: 1.5rem;
      }
      .form-group input,
      .form-group textarea,
      .form-group select {
        width: 100%;
        padding: 12px;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 0.95rem;
        transition: all 0.3s ease;
        font-family: "Poppins", sans-serif;
        background: #f8fafc;
      }
      .form-group input[type="file"] {
        padding: 8px;
      }
      .form-group input:focus,
      .form-group textarea:focus,
      .form-group select:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }
      .form-group label {
        position: absolute;
        top: 12px;
        left: 12px;
        font-size: 0.95rem;
        color: #666;
        transition: all 0.3s ease;
        pointer-events: none;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      .form-group input:not(:placeholder-shown) + label,
      .form-group textarea:not(:placeholder-shown) + label,
      .form-group select:not(:placeholder-shown) + label,
      .form-group input:focus + label,
      .form-group textarea:focus + label,
      .form-group select:focus + label {
        top: -10px;
        left: 8px;
        font-size: 0.75rem;
        color: #3b82f6;
        background: white;
        padding: 0 6px;
      }
      .form-group textarea {
        height: 120px;
        resize: vertical;
      }
      .form-group select:invalid {
        color: #999;
      }
      .quantity-group {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
      }
      .price-group {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1.5rem;
      }
      .price-group input[type="checkbox"] {
        width: auto;
        cursor: pointer;
      }
      .price-group label.checkbox-label {
        position: static;
        font-size: 0.95rem;
        color: #333;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      .image-preview {
        max-width: 200px;
        margin-top: 0.5rem;
        border-radius: 8px;
        display: none;
      }
      .specifications-container {
        margin-bottom: 1.5rem;
      }
      .spec-field {
        display: grid;
        grid-template-columns: 1fr 1fr 50px;
        gap: 1rem;
        margin-bottom: 1rem;
      }
      .spec-field button {
        background: #ef4444;
        color: white;
        border: none;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
      }
      .spec-field button:hover {
        background: #dc2626;
      }
      .add-spec-btn {
        background: #3b82f6;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 50px;
        cursor: pointer;
        font-size: 0.95rem;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
      }
      .add-spec-btn:hover {
        background: #2563eb;
        transform: translateY(-2px);
      }
      .submit-btn {
        background: linear-gradient(135deg, #3b82f6, #1e40af);
        color: white;
        padding: 12px 25px;
        border: none;
        border-radius: 50px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
      }
      .submit-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 30px rgba(59, 130, 246, 0.3);
      }
      .form-loading {
        display: none;
        text-align: center;
        margin: 1rem 0;
      }
      .form-loading.active {
        display: block;
      }
      .form-loading::after {
        content: "";
        display: inline-block;
        width: 24px;
        height: 24px;
        border: 3px solid #3b82f6;
        border-top: 3px solid transparent;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      .success-message {
        display: none;
        background: #d1fae5;
        color: #065f46;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
        text-align: center;
        font-weight: 500;
      }
      .success-message.active {
        display: block;
      }
      .error-message {
        color: #ef4444;
        font-size: 0.85rem;
        margin-top: 0.5rem;
        display: none;
        text-align: center;
      }
      .error-message.active {
        display: block;
      }
      .product-list table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        border-radius: 8px;
        overflow: hidden;
      }
      .product-list th,
      .product-list td {
        padding: 1rem;
        text-align: left;
        border-bottom: 1px solid #e2e8f0;
      }
      .product-list th {
        background: linear-gradient(135deg, #3b82f6, #1e40af);
        color: white;
        font-weight: 600;
      }
      .product-list tr:hover {
        background: #f1f5f9;
      }
      .action-btn {
        padding: 8px 16px;
        border-radius: 50px;
        cursor: pointer;
        border: none;
        font-size: 0.9rem;
        transition: all 0.3s ease;
      }
      .edit-btn {
        background: #3b82f6;
        color: white;
        margin-right: 0.5rem;
      }
      .edit-btn:hover {
        background: #2563eb;
        transform: translateY(-2px);
      }
      .delete-btn {
        background: #ef4444;
        color: white;
      }
      .delete-btn:hover {
        background: #dc2626;
        transform: translateY(-2px);
      }

      /* Footer */
      footer {
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        color: white;
        padding: 3rem 5% 1rem;
        margin-top: auto;
      }
      .footer-content {
        max-width: 1400px;
        margin: 0 auto;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 2rem;
      }
      .footer-section img {
        width: 100px;
        height: 60px;
        filter: invert(100%);
      }
      .footer-section h3 {
        font-size: 1.2rem;
        margin-bottom: 1rem;
        color: #3b82f6;
        font-weight: 600;
      }
      .footer-section p {
        color: #cbd5e1;
        font-size: 0.9rem;
      }
      .footer-bottom {
        text-align: center;
        margin-top: 2rem;
        padding-top: 1.5rem;
        border-top: 1px solid #334155;
        color: #94a3b8;
        font-size: 0.9rem;
      }

      /* Animations */
      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      .fade-in {
        opacity: 0;
        transform: translateY(20px);
      }

      /* Responsive Design */
      @media (max-width: 768px) {
        nav {
          padding: 1rem 3%;
        }
        .logo {
          font-size: 1.8rem;
        }
        .nav-links {
          position: fixed;
          top: 80px;
          left: 0;
          width: 100%;
          background: white;
          flex-direction: column;
          padding: 1.5rem;
          box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
          transform: translateY(-100%);
          opacity: 0;
          visibility: hidden;
          transition: all 0.3s ease;
        }
        .nav-links.active {
          transform: translateY(0);
          opacity: 1;
          visibility: visible;
        }
        .mobile-menu-btn {
          display: block;
        }
        .admin-section {
          padding: 80px 3% 60px;
        }
        .section-title {
          font-size: 2rem;
        }
        .spec-field {
          grid-template-columns: 1fr;
          gap: 0.5rem;
        }
        .spec-field button {
          width: 100%;
          border-radius: 8px;
        }
        .quantity-group {
          grid-template-columns: 1fr;
        }
        .price-group {
          flex-direction: column;
          align-items: flex-start;
        }
      }
      @media (max-width: 480px) {
        .section-title {
          font-size: 1.8rem;
        }
        .product-form,
        .product-list {
          padding: 1.5rem;
        }
      }
    </style>
  </head>
  <body>
    <!-- Header -->
    <header id="header">
      <nav>
        <div class="logo">
          <img src="/images/logo.svg" alt="" />
        </div>
        <ul class="nav-links" id="navLinks">
          <li><a href="/">Back to Home</a></li>
        </ul>
        <button class="mobile-menu-btn" id="mobileMenuBtn">
          <i class="fas fa-bars"></i>
        </button>
      </nav>
    </header>

    <!-- Admin Section -->
    <section class="admin-section">
      <div class="admin-container">
        <h2 class="section-title">Manage Products</h2>
        <div class="product-form fade-in">
          <h3>Add/Edit Product</h3>
          <form id="productForm">
            <input type="hidden" id="productId" name="id" />
            <input type="hidden" id="existingImage" name="existingImage" />
            <div class="success-message" id="formSuccess">
              Product saved successfully!
            </div>
            <div class="form-loading" id="formLoading"></div>
            <div class="error-message" id="formError"></div>
            <div class="form-group">
              <input
                type="text"
                id="name"
                name="name"
                placeholder=" "
                required
                aria-label="Product Name"
              />
              <label for="name"><i class="fas fa-box"></i> Product Name</label>
            </div>
            <div class="form-group">
              <select
                id="category"
                name="category"
                required
                aria-label="Product Category"
              >
                <option value="" disabled selected>Select Category</option>
                <!-- CHANGED: Hardcoded categories to match backend enum -->
                <option value="Earthing">Earthing</option>
                <option value="Lightning Protection">
                  Lightning Protection
                </option>
                <option value="Construction Use">Construction Use</option>
                <option value="Other">Other</option>
              </select>
              <label for="category"
                ><i class="fas fa-folder"></i> Category</label
              >
            </div>
            <div class="form-group">
              <input
                type="file"
                id="image"
                name="image"
                accept="image/*"
                aria-label="Product Image"
              />
              <label for="image"
                ><i class="fas fa-image"></i> Product Image</label
              >
              <img
                id="imagePreview"
                class="image-preview"
                alt="Image Preview"
              />
            </div>
            <div class="price-group">
              <div class="form-group">
                <input
                  type="number"
                  id="price"
                  name="price"
                  placeholder=" "
                  min="0"
                  step="0.01"
                  aria-label="Price"
                />
                <label for="price"
                  ><i class="fas fa-rupee-sign"></i> Price (INR)</label
                >
              </div>
              <label class="checkbox-label">
                <input
                  type="checkbox"
                  id="customPrice"
                  name="customPrice"
                  aria-label="Custom Price"
                />
                As per requirement
              </label>
            </div>
            <div class="quantity-group">
              <div class="form-group">
                <input
                  type="number"
                  id="quantityValue"
                  name="quantityValue"
                  placeholder=" "
                  min="0"
                  step="0.01"
                  required
                  aria-label="Quantity Value"
                />
                <label for="quantityValue"
                  ><i class="fas fa-balance-scale"></i> Quantity</label
                >
              </div>
              <div class="form-group">
                <select
                  id="quantityUnit"
                  name="quantityUnit"
                  required
                  aria-label="Quantity Unit"
                >
                  <option value="" disabled selected>Select Unit</option>
                  <option value="kg">Per Kilogram (kg)</option>
                  <option value="item">Per Item</option>
                  <option value="meter">Per Meter (m)</option>
                  <option value="set">Per Set (set)</option>
                </select>
                <label for="quantityUnit"
                  ><i class="fas fa-ruler"></i> Unit</label
                >
              </div>
            </div>
            <div class="form-group">
              <input
                type="text"
                id="shortDescription"
                name="shortDescription"
                placeholder=" "
                required
                aria-label="Short Description"
              />
              <label for="shortDescription"
                ><i class="fas fa-align-left"></i> Short Description</label
              >
            </div>
            <div class="form-group">
              <textarea
                id="description"
                name="description"
                placeholder=" "
                required
                aria-label="Full Description"
              ></textarea>
              <label for="description"
                ><i class="fas fa-file-alt"></i> Full Description</label
              >
            </div>
            <div class="form-group">
              <textarea
                id="keyFeatures"
                name="keyFeatures"
                placeholder=" "
                required
                aria-label="Key Features"
              ></textarea>
              <label for="keyFeatures"
                ><i class="fas fa-star"></i> Key Features
                (comma-separated)</label
              >
            </div>
            <div class="specifications-container">
              <h4>Specifications</h4>
              <div id="specFields"></div>
              <button type="button" class="add-spec-btn" id="addSpecBtn">
                <i class="fas fa-plus"></i> Add Specification
              </button>
            </div>
            <button type="submit" class="submit-btn">
              <i class="fas fa-save"></i> Save Product
            </button>
          </form>
        </div>
        <div class="product-list fade-in">
          <h3>Product List</h3>
          <table>
            <thead>
              <tr>
                <th>Name</th>
                <th>Price</th>
                <th>Quantity</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="productTable"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Footer -->
    <footer>
      <div class="footer-content">
        <div class="footer-section">
          <img src="/images/logo.svg" alt="" />
          <p>
            Admin panel for managing electrical safety products. GSTIN:
            06CROPS7313B1ZQ
          </p>
        </div>
      </div>
      <div class="footer-bottom">
        <p>© 2025 VAISHNO ELECTRICALS. All rights reserved.</p>
      </div>
    </footer>

    <script>
      const adminToken = localStorage.getItem("adminToken");

      // Authentication Check
      if (!localStorage.getItem("adminAuth")) {
        window.location.href = "/";
      }

      // Mobile Menu Toggle
      const mobileMenuBtn = document.getElementById("mobileMenuBtn");
      const navLinks = document.getElementById("navLinks");

      mobileMenuBtn.addEventListener("click", () => {
        navLinks.classList.toggle("active");
        const icon = mobileMenuBtn.querySelector("i");
        icon.classList.toggle("fa-bars");
        icon.classList.toggle("fa-times");
      });

      // Header Scroll Effect
      const header = document.getElementById("header");
      window.addEventListener("scroll", () => {
        header.classList.toggle("header-scrolled", window.scrollY > 100);
      });

      // Scroll Animations
      const observer = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              entry.target.style.animation = "fadeInUp 0.8s ease forwards";
            }
          });
        },
        { threshold: 0.1 }
      );

      document.querySelectorAll(".fade-in").forEach((el) => {
        el.style.opacity = "0";
        el.style.transform = "translateY(20px)";
        observer.observe(el);
      });

      // Image Preview
      const imageInput = document.getElementById("image");
      const imagePreview = document.getElementById("imagePreview");

      imageInput.addEventListener("change", () => {
        const file = imageInput.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (e) => {
            imagePreview.src = e.target.result;
            imagePreview.style.display = "block";
          };
          reader.readAsDataURL(file);
        } else {
          imagePreview.style.display = "none";
        }
      });

      // Price Toggle
      const customPriceCheckbox = document.getElementById("customPrice");
      const priceInput = document.getElementById("price");

      customPriceCheckbox.addEventListener("change", () => {
        if (customPriceCheckbox.checked) {
          priceInput.disabled = true;
          priceInput.value = "";
        } else {
          priceInput.disabled = false;
        }
      });

      // Dynamic Specifications
      const specFields = document.getElementById("specFields");
      const addSpecBtn = document.getElementById("addSpecBtn");

      function addSpecField(key = "", value = "") {
        const id = `spec_${Date.now()}`;
        const field = document.createElement("div");
        field.className = "spec-field";
        field.innerHTML = `
          <div class="form-group">
            <input type="text" id="${id}_key" value="${key}" placeholder=" " required aria-label="Specification Key" />
            <label for="${id}_key"><i class="fas fa-tag"></i> Key</label>
          </div>
          <div class="form-group">
            <input type="text" id="${id}_value" value="${value}" placeholder=" " required aria-label="Specification Value" />
            <label for="${id}_value"><i class="fas fa-info-circle"></i> Value</label>
          </div>
          <button type="button" class="remove-spec"><i class="fas fa-times"></i></button>
        `;
        specFields.appendChild(field);

        field.querySelector(".remove-spec").addEventListener("click", () => {
          field.remove();
        });
      }

      addSpecBtn.addEventListener("click", () => addSpecField());

      // Load Products
      async function loadProducts() {
        const errorMessage = document.getElementById("formError");
        errorMessage.style.display = "none";
        try {
          const response = await fetch("/api/admin/products", {
            headers: {
              Authorization: `Bearer ${adminToken}`,
            },
          });
          if (!response.ok) {
            throw new Error(
              `HTTP ${response.status}: ${await response.text()}`
            );
          }
          const products = await response.json();
          const productTable = document.getElementById("productTable");
          productTable.innerHTML = "";
          if (!Array.isArray(products) || products.length === 0) {
            productTable.innerHTML =
              '<tr><td colspan="4">No products found.</td></tr>';
            return;
          }
          products.forEach((product) => {
            const price =
              typeof product.price === "string"
                ? product.price
                : `₹${product.price.toFixed(2)}`;
            const quantity = product.quantity
              ? `${product.quantity.value} ${product.quantity.unit}`
              : "N/A";
            const tr = `
              <tr>
                <td>${product.name}</td>
                <td>${price}</td>
                <td>${quantity}</td>
                <td>
                  <button class="action-btn edit-btn" onclick="editProduct('${product.id}')"><i class="fas fa-edit"></i> Edit</button>
                  <button class="action-btn delete-btn" onclick="deleteProduct('${product.id}')"><i class="fas fa-trash"></i> Delete</button>
                </td>
              </tr>
            `;
            productTable.insertAdjacentHTML("beforeend", tr);
          });
        } catch (error) {
          console.error("Error loading products:", error);
          errorMessage.textContent =
            "Failed to load products. Please try logging in again.";
          errorMessage.classList.add("active");
          if (error.message.includes("401")) {
            localStorage.removeItem("adminAuth");
            localStorage.removeItem("adminToken");
            window.location.href = "/";
          }
        }
      }

      // Product Form Submission
      const productForm = document.getElementById("productForm");
      productForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const loading = document.getElementById("formLoading");
        const success = document.getElementById("formSuccess");
        const errorMessage = document.getElementById("formError");
        loading.classList.add("active");
        success.classList.remove("active");
        errorMessage.classList.remove("active");

        const name = document.getElementById("name").value.trim();
        const category = document.getElementById("category").value; // CHANGED: Renamed from categoryId
        const customPrice = document.getElementById("customPrice").checked;
        const price = customPrice
          ? "As per requirement"
          : parseFloat(document.getElementById("price").value) || 0;
        const quantityValue =
          parseFloat(document.getElementById("quantityValue").value) || 0;
        const quantityUnit = document.getElementById("quantityUnit").value;
        const shortDescription = document
          .getElementById("shortDescription")
          .value.trim();
        const description = document.getElementById("description").value.trim();
        const keyFeatures = document
          .getElementById("keyFeatures")
          .value.split(",")
          .map((f) => f.trim())
          .filter((f) => f);
        const specifications = [];
        specFields.querySelectorAll(".spec-field").forEach((field) => {
          const key = field.querySelector("input[id$='_key']").value.trim();
          const value = field.querySelector("input[id$='_value']").value.trim();
          if (key && value) {
            specifications.push({ key, value });
          }
        });

        // Validation
        if (
          !name ||
          !category ||
          (!customPrice && (isNaN(price) || price < 0)) ||
          quantityValue <= 0 ||
          !quantityUnit ||
          !shortDescription ||
          !description ||
          keyFeatures.length === 0 ||
          specifications.length === 0
        ) {
          loading.classList.remove("active");
          errorMessage.textContent =
            "Please fill in all required fields, including a valid price (if not custom), quantity (>0) with unit, and category.";
          errorMessage.classList.add("active");
          return;
        }

        try {
          let imageUrl = document.getElementById("existingImage").value;
          if (imageInput.files[0]) {
            const imageFormData = new FormData();
            imageFormData.append("image", imageInput.files[0]);
            const imageResponse = await fetch("/api/admin/upload-image", {
              method: "POST",
              headers: { Authorization: `Bearer ${adminToken}` },
              body: imageFormData,
            });
            if (!imageResponse.ok) {
              throw new Error(
                `Image upload failed: ${await imageResponse.text()}`
              );
            }
            const imageData = await imageResponse.json();
            imageUrl = imageData.imageUrl;
          }

          if (!imageUrl && !document.getElementById("productId").value) {
            throw new Error("An image is required for new products.");
          }

          const productData = {
            id:
              document.getElementById("productId").value ||
              `prod_${Date.now()}`,
            name,
            price,
            quantity: {
              value: quantityValue,
              unit: quantityUnit,
            },
            image: imageUrl,
            shortDescription,
            description,
            keyFeatures,
            specifications,
            category, // CHANGED: Send category as string instead of { id: categoryId }
          };

          const method = productData.id.startsWith("prod_") ? "POST" : "PUT";
          const url =
            method === "PUT"
              ? `/api/admin/products/${productData.id}`
              : "/api/admin/products";

          const response = await fetch(url, {
            method,
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${adminToken}`,
            },
            body: JSON.stringify(productData),
          });

          if (response.ok) {
            success.classList.add("active");
            productForm.reset();
            imagePreview.style.display = "none";
            document.getElementById("existingImage").value = "";
            specFields.innerHTML = "";
            document.getElementById("productId").value = "";
            document.getElementById("quantityUnit").value = "";
            document.getElementById("category").value = "";
            customPriceCheckbox.checked = false;
            priceInput.disabled = false;
            loadProducts();
            setTimeout(() => success.classList.remove("active"), 3000);
          } else {
            throw new Error(`Failed to save product: ${await response.text()}`);
          }
        } catch (error) {
          console.error("Error saving product:", error);
          errorMessage.textContent = error.message.includes("401")
            ? "Session expired. Please log in again."
            : "An error occurred while saving the product.";
          errorMessage.classList.add("active");
          if (error.message.includes("401")) {
            localStorage.removeItem("adminAuth");
            localStorage.removeItem("adminToken");
            window.location.href = "/";
          }
        } finally {
          loading.classList.remove("active");
        }
      });

      // Edit Product
      window.editProduct = async (id) => {
        try {
          const response = await fetch(`/api/admin/products/${id}`, {
            headers: {
              Authorization: `Bearer ${adminToken}`,
            },
          });
          if (!response.ok) {
            throw new Error(
              `HTTP ${response.status}: ${await response.text()}`
            );
          }
          const product = await response.json();
          document.getElementById("productId").value = product.id;
          document.getElementById("name").value = product.name;
          document.getElementById("category").value = product.category || ""; // CHANGED: Use category string directly
          if (product.price === "As per requirement") {
            document.getElementById("customPrice").checked = true;
            document.getElementById("price").disabled = true;
            document.getElementById("price").value = "";
          } else {
            document.getElementById("customPrice").checked = false;
            document.getElementById("price").disabled = false;
            document.getElementById("price").value = product.price || 0;
          }
          document.getElementById("quantityValue").value = product.quantity
            ? product.quantity.value
            : 0;
          document.getElementById("quantityUnit").value = product.quantity
            ? product.quantity.unit
            : "";
          document.getElementById("existingImage").value = product.image;
          imagePreview.src = product.image;
          imagePreview.style.display = "block";
          document.getElementById("shortDescription").value =
            product.shortDescription;
          document.getElementById("description").value = product.description;
          document.getElementById("keyFeatures").value =
            product.keyFeatures.join(", ");
          specFields.innerHTML = "";
          product.specifications.forEach((spec) => {
            addSpecField(spec.key, spec.value);
          });
        } catch (error) {
          console.error("Error fetching product:", error);
          document.getElementById("formError").textContent =
            error.message.includes("401")
              ? "Session expired. Please log in again."
              : "Failed to load product details.";
          document.getElementById("formError").classList.add("active");
          if (error.message.includes("401")) {
            localStorage.removeItem("adminAuth");
            localStorage.removeItem("adminToken");
            window.location.href = "/";
          }
        }
      };

      // Delete Product
      window.deleteProduct = async (id) => {
        if (confirm("Are you sure you want to delete this product?")) {
          try {
            const response = await fetch(`/api/admin/products/${id}`, {
              method: "DELETE",
              headers: {
                Authorization: `Bearer ${adminToken}`,
              },
            });
            if (response.ok) {
              document.getElementById("formSuccess").textContent =
                "Product deleted successfully!";
              document.getElementById("formSuccess").classList.add("active");
              loadProducts();
              setTimeout(
                () =>
                  document
                    .getElementById("formSuccess")
                    .classList.remove("active"),
                3000
              );
            } else {
              throw new Error(
                `Failed to delete product: ${await response.text()}`
              );
            }
          } catch (error) {
            console.error("Error deleting product:", error);
            document.getElementById("formError").textContent =
              error.message.includes("401")
                ? "Session expired. Please log in again."
                : "An error occurred while deleting the product.";
            document.getElementById("formError").classList.add("active");
            if (error.message.includes("401")) {
              localStorage.removeItem("adminAuth");
              localStorage.removeItem("adminToken");
              window.location.href = "/";
            }
          }
        }
      };

      // Initialize
      window.addEventListener("load", () => {
        document.body.style.opacity = "1";
        addSpecField();
        loadProducts();
        // CHANGED: Removed loadCategories call since categories are hardcoded
      });

      document.body.style.opacity = "0";
      document.body.style.transition = "opacity 0.5s ease";
    </script>
  </body>
</html>
